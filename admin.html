<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel Admin • Jéssica Personal</title>
<link rel="icon" href="logo.ico">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  :root {
    --primary: #ff4fa3;
    --secondary: #ff1f6d;
    --glass-bg: rgba(20, 10, 20, 0.95);
    --glass-border: rgba(255, 255, 255, 0.1);
    --card-bg: rgba(255, 255, 255, 0.05);
    --sidebar-width: 260px;
    --success: #00e676;
    --danger: #ff1744;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; }

  body {
    background: linear-gradient(-45deg, #0a0a14, #180511, #2a0a1f, #12000b);
    background-size: 400% 400%;
    animation: gradientBG 15s ease infinite;
    color: #fff;
    min-height: 100vh;
    display: none; /* Só aparece se for admin */
    overflow-x: hidden;
  }

  @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

  /* LOADING */
  #loadingOverlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9); backdrop-filter: blur(5px);
    display: flex; justify-content: center; align-items: center; z-index: 9999;
  }
  .loader {
    width: 50px; height: 50px; border: 4px solid rgba(255,79,163,0.3);
    border-top: 4px solid #ff4fa3; border-radius: 50%; animation: spin 1s linear infinite;
  }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  /* LAYOUT */
  .admin-layout { display: flex; min-height: 100vh; }

  /* SIDEBAR */
  .sidebar {
    width: var(--sidebar-width);
    background: var(--glass-bg);
    border-right: 1px solid var(--glass-border);
    backdrop-filter: blur(20px);
    padding: 25px;
    position: fixed;
    height: 100vh;
    display: flex;
    flex-direction: column;
    z-index: 100;
    transition: transform 0.3s ease;
  }

  .brand {
    font-size: 20px; font-weight: 700; color: #fff; margin-bottom: 40px;
    display: flex; align-items: center; gap: 10px;
  }
  .brand i { color: var(--primary); }

  .menu-item {
    display: flex; align-items: center; gap: 12px;
    padding: 14px 16px; margin-bottom: 8px;
    border-radius: 12px; cursor: pointer;
    color: rgba(255,255,255,0.6);
    transition: 0.3s; font-size: 14px; font-weight: 500;
  }
  .menu-item:hover, .menu-item.active {
    background: rgba(255, 79, 163, 0.15); color: #fff;
  }
  .menu-item.active { border-left: 3px solid var(--primary); }

  .sidebar-footer { margin-top: auto; padding-top: 20px; border-top: 1px solid var(--glass-border); }
  .logout-btn {
    width: 100%; padding: 12px; background: rgba(255, 23, 68, 0.1);
    color: #ff1744; border: 1px solid rgba(255, 23, 68, 0.2);
    border-radius: 10px; cursor: pointer; font-weight: 600;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    transition: 0.3s;
  }
  .logout-btn:hover { background: rgba(255, 23, 68, 0.2); }

  /* MAIN CONTENT */
  .main {
    flex: 1; margin-left: var(--sidebar-width); padding: 30px;
    width: calc(100% - var(--sidebar-width));
    transition: margin 0.3s ease, width 0.3s ease;
  }

  .header {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;
  }
  .header h2 { font-size: 24px; font-weight: 700; }
  .user-info { display: flex; align-items: center; gap: 10px; font-size: 14px; opacity: 0.8; }
  .user-avatar { width: 35px; height: 35px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }

  /* MOBILE HEADER (Escondido no Desktop) */
  .mobile-header {
      display: none;
      align-items: center; justify-content: space-between;
      margin-bottom: 20px; padding-bottom: 15px;
      border-bottom: 1px solid var(--glass-border);
  }
  .menu-toggle { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }

  /* DASHBOARD CARDS */
  .cards-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px; margin-bottom: 30px;
  }
  .card {
    background: var(--card-bg); border: 1px solid var(--glass-border);
    border-radius: 20px; padding: 25px; position: relative; overflow: hidden;
    backdrop-filter: blur(10px); transition: 0.3s;
  }
  .card:hover { transform: translateY(-5px); border-color: rgba(255,255,255,0.2); }
  
  .card-icon {
    position: absolute; top: 20px; right: 20px;
    width: 40px; height: 40px; border-radius: 10px;
    background: rgba(255,255,255,0.05); color: var(--primary);
    display: flex; align-items: center; justify-content: center; font-size: 18px;
  }
  
  .card h3 { font-size: 14px; color: rgba(255,255,255,0.6); margin-bottom: 10px; font-weight: 500; }
  .card span { font-size: 28px; font-weight: 700; color: #fff; }
  
  /* PAINÉIS */
  .dashboard-panels { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
  
  .panel-box {
    background: var(--card-bg); border: 1px solid var(--glass-border);
    border-radius: 20px; padding: 25px; backdrop-filter: blur(10px);
  }
  .panel-title { font-size: 16px; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
  .panel-title i { color: var(--primary); }

  /* TABELA DE ALUNOS */
  .search-box { margin-bottom: 20px; position: relative; }
  .search-box input {
    width: 100%; padding: 14px 14px 14px 45px; border-radius: 12px;
    background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
    color: #fff; outline: none; font-size: 14px;
  }
  .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: rgba(255,255,255,0.4); }

  .table-responsive { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 14px; }
  th { text-align: left; padding: 15px; color: rgba(255,255,255,0.5); font-weight: 600; border-bottom: 1px solid var(--glass-border); }
  td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); color: rgba(255,255,255,0.9); }
  tr:hover td { background: rgba(255,255,255,0.02); }

  /* BADGES */
  .badge { padding: 5px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
  .badge.basic { background: rgba(255,255,255,0.1); color: #fff; }
  .badge.premium { background: rgba(255, 79, 163, 0.2); color: #ff9ac7; border: 1px solid rgba(255, 79, 163, 0.3); }

  /* BOTÕES DE AÇÃO */
  .actions { display: flex; gap: 8px; }
  .btn-icon {
    width: 32px; height: 32px; border-radius: 8px; border: none; cursor: pointer;
    display: flex; align-items: center; justify-content: center; transition: 0.2s;
  }
  .btn-edit { background: rgba(37, 99, 235, 0.2); color: #60a5fa; }
  .btn-edit:hover { background: #2563eb; color: #fff; }
  
  .btn-delete { background: rgba(255, 23, 68, 0.2); color: #ff1744; }
  .btn-delete:hover { background: #ff1744; color: #fff; }
  
  .btn-train { background: rgba(0, 230, 118, 0.2); color: #00e676; }
  .btn-train:hover { background: #00e676; color: #000; }

  /* CONTENT SECTIONS */
  .content-section { display: none; animation: fadeIn 0.4s; }
  .content-section.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  /* MODAL */
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
    display: none; justify-content: center; align-items: center; z-index: 2000;
  }
  .modal-box {
    background: #1a1a24; border: 1px solid var(--glass-border);
    border-radius: 20px; padding: 30px; width: 90%; max-width: 450px;
    box-shadow: 0 25px 50px rgba(0,0,0,0.5);
  }
  .modal-box h3 { margin-bottom: 20px; color: #fff; font-size: 20px; }
  
  .modal-box select {
    width: 100%; padding: 12px; border-radius: 10px;
    background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
    color: #fff; outline: none; margin-bottom: 20px;
  }
  
  .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
  .btn-modal { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; }
  .btn-cancel { background: transparent; color: #aaa; border: 1px solid rgba(255,255,255,0.1); }
  .btn-confirm { background: var(--primary); color: #fff; }

  /* OVERLAY MOBILE */
  .overlay-mobile {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 90;
      display: none;
  }
  .overlay-mobile.active { display: block; }

  /* RESPONSIVO */
  @media (max-width: 900px) {
    .sidebar { transform: translateX(-100%); width: 260px; }
    .sidebar.active { transform: translateX(0); }
    .main { margin-left: 0; width: 100%; padding: 20px; }
    .dashboard-panels { grid-template-columns: 1fr; }
    .header { display: none; } 
    .mobile-header { display: flex; }
  }

  /* --- CORREÇÃO PARA MOBILE JÉSSICA PERSONAL --- */
body {
    min-height: 100vh !important;
    width: 100% !important;
    margin: 0;
    /* Aqui vai o fundo que você usa no PC. Exemplo de um tom escuro Premium: */
    background: #0f0f0f !important; 
    background-attachment: fixed !important;
    background-size: cover !important;
}

/* Isso garante que nada no meio do caminho force a cor branca */
html, #root, .main-container {
    background-color: transparent !important;
}
</style>
</head>
<body>

<div id="loadingOverlay">
  <div class="loader"></div>
</div>

<div id="overlayMobile" class="overlay-mobile" onclick="toggleMenu()"></div>

<div id="planModal" class="modal-overlay">
  <div class="modal-box">
    <h3><i class="fa-solid fa-pen-to-square"></i> Editar Plano</h3>
    <select id="planSelect">
      <option value="Iniciante-Academia">Iniciante - Academia (R$ 39,90)</option>
      <option value="Intermediário-Academia">Intermediário - Academia (R$ 69,90)</option>
      <option value="Avançado-Academia">Avançado - Academia (R$ 89,90)</option>
      <option value="Iniciante-Casa">Iniciante - Casa (R$ 39,90)</option>
      <option value="Intermediário-Casa">Intermediário - Casa (R$ 59,90)</option>
      <option value="Avançado-Casa">Avançado - Casa (R$ 79,90)</option>
    </select>
    <div class="modal-actions">
      <button class="btn-modal btn-cancel" onclick="closePlanModal()">Cancelar</button>
      <button class="btn-modal btn-confirm" onclick="salvarPlano()">Salvar Alterações</button>
    </div>
  </div>
</div>

<div class="admin-layout">
  
  <div class="sidebar" id="sidebar">
    <div class="brand">
      <i class="fa-solid fa-bolt"></i>
      <span>Painel Admin</span>
    </div>

    <div class="menu-item active" onclick="showSection('dashboard')">
      <i class="fa-solid fa-chart-pie"></i>
      <span>Dashboard</span>
    </div>
    
    <div class="menu-item" onclick="showSection('alunos')">
      <i class="fa-solid fa-users"></i>
      <span>Gerenciar Alunos</span>
    </div>

    <div class="menu-item" onclick="window.location.href='montar-treino.html'">
      <i class="fa-solid fa-dumbbell"></i>
      <span>Montar Treino</span>
    </div>

    <div class="menu-item" onclick="window.location.href='painel-anamnese.html'">
      <i class="fa-solid fa-clipboard-list"></i>
      <span>Anamneses</span>
    </div>

    <div class="sidebar-footer">
      <button class="logout-btn" onclick="logout()">
        <i class="fa-solid fa-right-from-bracket"></i>
        <span>Sair</span>
      </button>
    </div>
  </div>

  <div class="main">
    
    <div class="mobile-header">
        <button class="menu-toggle" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></button>
        <h3>Jéssica Admin</h3>
        <div style="width:24px"></div>
    </div>
    
    <div class="header">
      <h2 id="section-title">Dashboard</h2>
      <div class="user-info">
        <span>Admin Logado</span>
        <div class="user-avatar">A</div>
      </div>
    </div>

    <div id="dashboard" class="content-section active">
      <div class="cards-grid">
        <div class="card">
          <div class="card-icon"><i class="fa-solid fa-users"></i></div>
          <h3>Total de Alunos</h3>
          <span id="totalUsers">0</span>
        </div>
        <div class="card">
          <div class="card-icon"><i class="fa-solid fa-crown"></i></div>
          <h3>Alunos Premium</h3>
          <span id="premiumUsers">0</span>
        </div>
        <div class="card">
          <div class="card-icon"><i class="fa-solid fa-user-plus"></i></div>
          <h3>Novos Hoje</h3>
          <span id="newToday">0</span>
        </div>
        <div class="card">
          <div class="card-icon"><i class="fa-solid fa-sack-dollar"></i></div>
          <h3>Receita Estimada</h3>
          <span id="totalRevenue">R$ 0,00</span>
        </div>
      </div>

      <div class="dashboard-panels">
        <div class="panel-box">
          <div class="panel-title"><i class="fa-solid fa-clock-rotate-left"></i> Últimos Cadastros</div>
          <table style="width:100%">
             <tbody id="lastUsersTable"></tbody>
          </table>
        </div>

        <div class="panel-box">
          <div class="panel-title"><i class="fa-solid fa-server"></i> Status do Sistema</div>
          <div style="margin-bottom: 15px;">
            <p style="font-size:13px; color:#aaa; margin-bottom:5px;">Firebase Auth</p>
            <div style="color:#00e676; font-weight:600; font-size:14px;"><i class="fa-solid fa-circle" style="font-size:10px;"></i> Operacional</div>
          </div>
          <div>
            <p style="font-size:13px; color:#aaa; margin-bottom:5px;">Firestore Database</p>
            <div style="color:#00e676; font-weight:600; font-size:14px;"><i class="fa-solid fa-circle" style="font-size:10px;"></i> Operacional</div>
          </div>
        </div>
      </div>
    </div>

    <div id="alunos" class="content-section">
      <div class="panel-box">
        <div class="search-box">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input type="text" id="search" placeholder="Buscar aluno por nome ou email..." onkeyup="filtrarUsuarios()">
        </div>
        
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th>Nome / Email</th>
                <th>Plano Atual</th>
                <th>Status</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="userList"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, getDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAKLvhy6r6tLSMIEt-mZcfHWuiKHHibdcY",
  authDomain: "meusiteteste1-7b880.firebaseapp.com",
  projectId: "meusiteteste1-7b880",
  storageBucket: "meusiteteste1-7b880.appspot.com",
  messagingSenderId: "107598819774",
  appId: "1:107598819774:web:1e369753c4b7908a6209ef"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const ADMIN_EMAIL = "arthurdinizrede@gmail.com";
const PLAN_PRICES = {
  "Iniciante-Academia": 39.90, "Intermediário-Academia": 69.90, "Avançado-Academia": 89.90,
  "Iniciante-Casa": 39.90, "Intermediário-Casa": 59.90, "Avançado-Casa": 79.90, "Básico": 0
};

let currentUserId = null;

function showLoading(show=true){
  document.getElementById("loadingOverlay").style.display = show ? "flex" : "none";
}

// TOGGLE MENU MOBILE (ADICIONADO)
window.toggleMenu = function() {
    const sb = document.getElementById("sidebar");
    const ov = document.getElementById("overlayMobile");
    sb.classList.toggle("active");
    ov.classList.toggle("active");
}

window.showSection = function(sectionId) {
  document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
  document.getElementById(sectionId).classList.add('active');
  
  const menuItems = document.querySelectorAll('.menu-item');
  if(sectionId === 'dashboard') menuItems[0].classList.add('active');
  if(sectionId === 'alunos') menuItems[1].classList.add('active');
  
  // Fecha menu ao clicar se estiver no mobile
  if(window.innerWidth < 900) toggleMenu();
  
  document.getElementById('section-title').innerText = sectionId === 'dashboard' ? 'Dashboard Geral' : 'Gerenciamento de Alunos';
};

window.openPlanModal = function(userId, planoAtual) {
  currentUserId = userId;
  document.getElementById("planSelect").value = planoAtual || 'Básico';
  document.getElementById("planModal").style.display = "flex";
};

window.closePlanModal = function() {
  document.getElementById("planModal").style.display = "none";
};

window.salvarPlano = async function() {
  const novoPlano = document.getElementById("planSelect").value;
  showLoading(true);
  try {
    await updateDoc(doc(db, "users", currentUserId), { plano: novoPlano });
    closePlanModal();
    carregarUsuarios();
    alert("Plano atualizado!");
  } catch (err) {
    console.error(err);
    alert("Erro ao atualizar.");
  } finally {
    showLoading(false);
  }
};

window.excluirAluno = async function(docId, email, role) {
  if(role === "admin") return alert("Não pode excluir admin.");
  if(!confirm(`Excluir ${email}?`)) return;

  showLoading(true);
  try {
    await deleteDoc(doc(db, "users", docId));
    carregarUsuarios();
  } catch (error) {
    alert("Erro ao excluir.");
  } finally {
    showLoading(false);
  }
};

onAuthStateChanged(auth, async (user) => {
  if (user) {
    try {
        // Verifica se é admin por email ou banco
        if (user.email === ADMIN_EMAIL) {
             document.body.style.display = "block";
             showLoading(false);
             carregarUsuarios();
             return;
        }
        
        const docRef = doc(db, "users", user.uid);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists() && docSnap.data().role === "admin") {
          document.body.style.display = "block";
          showLoading(false);
          carregarUsuarios();
        } else {
          window.location.href = "aulas.html";
        }
    } catch(e) {
        // Fallback
        if(user.email === ADMIN_EMAIL) {
             document.body.style.display = "block";
             showLoading(false);
             carregarUsuarios();
        }
    }
  } else {
    window.location.href = "login.html";
  }
});

async function carregarUsuarios() {
  const tbody = document.getElementById("userList");
  const lastTable = document.getElementById("lastUsersTable");
  
  if(tbody) tbody.innerHTML = "";
  if(lastTable) lastTable.innerHTML = "";

  const snapshot = await getDocs(collection(db, "users"));
  
  let total = 0, premium = 0, novosHoje = 0, receita = 0;
  const hoje = new Date().toDateString();
  const usersData = [];

  snapshot.forEach(docSnap => {
    const u = docSnap.data();
    usersData.push({ id: docSnap.id, ...u });
    
    total++;
    const plano = u.plano || "Básico";
    if (plano.includes("Avançado") || plano.includes("Intermediário")) premium++;
    receita += PLAN_PRICES[plano] ?? 0;
    
    if (u.criadoEm) { 
       try {
           const d = u.criadoEm.toDate ? u.criadoEm.toDate() : new Date(u.criadoEm);
           if(d.toDateString() === hoje) novosHoje++;
       } catch(e) {}
    }

    const badgeClass = (plano !== 'Básico') ? 'premium' : 'basic';
    // Proteção para email (aspas)
    const emailSeguro = u.email ? u.email.replace(/'/g, "") : "";

    if(tbody) {
        tbody.innerHTML += `
          <tr>
            <td>
                <div style="font-weight:600; color:#fff">${u.nome || 'Sem Nome'}</div>
                <div style="font-size:12px; opacity:0.6">${u.email || '-'}</div>
            </td>
            <td><span class="badge ${badgeClass}">${plano}</span></td>
            <td><span style="color:#00e676; font-size:12px">● Ativo</span></td>
            <td>
              <div class="actions">
                <button class="btn-icon btn-train" title="Montar Treino" onclick="window.location.href='montar-treino.html?email=${emailSeguro}'">
                   <i class="fa-solid fa-dumbbell"></i>
                </button>
                <button class="btn-icon btn-edit" title="Editar Plano" onclick="openPlanModal('${docSnap.id}', '${plano}')">
                   <i class="fa-solid fa-pen"></i>
                </button>
                <button class="btn-icon btn-delete" title="Excluir" onclick="excluirAluno('${docSnap.id}', '${emailSeguro}', '${u.role}')">
                   <i class="fa-solid fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>`;
    }
  });

  document.getElementById("totalUsers").innerText = total;
  document.getElementById("premiumUsers").innerText = premium;
  document.getElementById("newToday").innerText = novosHoje;
  document.getElementById("totalRevenue").innerText = receita.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });

  if(lastTable) {
      usersData.slice(-5).reverse().forEach(u => {
          lastTable.innerHTML += `
            <tr>
                <td style="padding:10px 0; border:none;">
                    <div style="font-size:13px; font-weight:600">${u.email || 'Sem email'}</div>
                    <div style="font-size:11px; opacity:0.5">Novo Aluno</div>
                </td>
            </tr>
          `;
      });
  }
}

window.filtrarUsuarios = function() {
  const termo = document.getElementById("search").value.toLowerCase();
  const rows = document.querySelectorAll("#userList tr");
  rows.forEach(row => {
    const texto = row.innerText.toLowerCase();
    row.style.display = texto.includes(termo) ? "" : "none";
  });
};

window.logout = () => signOut(auth).then(() => window.location.href = "login.html");
</script>

</body>
</html>