<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel Admin</title>
<link rel="icon" href="logo.ico">

<style>
/* Estilos Base */
body {
  display: none; 
  margin: 0;
  font-family: 'Segoe UI', Arial, sans-serif;
  background: linear-gradient(135deg, #0a0a14, #12081a, #2a0a1f);
  color: white;
  min-height: 100vh;
}

.admin-layout { display: flex; min-height: 100vh; }
.sidebar { width: 240px; background: rgba(255,255,255,0.05); border-right: 1px solid rgba(255,255,255,0.1); padding: 20px; backdrop-filter: blur(12px); }
.sidebar h2 { font-size: 18px; margin-bottom: 20px; }
.menu-item { padding: 12px; border-radius: 10px; cursor: pointer; margin-bottom: 8px; transition: .2s; }
.menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); border-left: 4px solid #ff1f6d; }
.main { flex: 1; padding: 25px; }
.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
.logout { background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 14px; border-radius: 10px; cursor: pointer; }
.logout:hover { background: rgba(255,255,255,0.1); }

/* Cards Dashboard */
.cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
.card { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 16px; padding: 18px; backdrop-filter: blur(12px); }
.card span { font-size: 28px; font-weight: bold; }

/* Tabelas e Caixas */
.search-box { margin-bottom: 12px; }
.search-box input { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.08); color: white; outline: none; }
.table-box { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 16px; padding: 15px; backdrop-filter: blur(12px); overflow-x: auto; margin-bottom: 25px; }
table { width: 100%; border-collapse: collapse; font-size: 14px; }
th, td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: left; }

/* BotÃµes de AÃ§Ã£o */
button.action { padding: 6px 10px; border-radius: 8px; border: none; cursor: pointer; font-size: 12px; margin-right: 5px; }
.btn-delete { background: #ff1f6d; color: white; }
.btn-plan { background: #ffd1e8; color: #2a0a1f; }
.btn-view { background: #2563eb; color: white; }

/* FormulÃ¡rio de Treino */
.admin-container { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 16px; padding: 20px; backdrop-filter: blur(12px); }
#training-form { display: flex; flex-direction: column; gap: 12px; }
#training-form input, #training-form textarea { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); padding: 12px; border-radius: 10px; color: white; outline: none; }
#training-form button { background: #ff1f6d; color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: bold; }

/* Modal */
.modal-overlay {
    display: none; 
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(8px);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}
.modal-content {
    background: rgba(20, 10, 30, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    width: 90%;
    max-width: 500px;
    padding: 25px;
    color: white;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    animation: fadeIn 0.3s ease;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding-bottom: 15px;
    margin-bottom: 20px;
}
.close-modal { font-size: 28px; cursor: pointer; color: rgba(255,255,255,0.6); }
.close-modal:hover { color: #ff1f6d; }
.info-item { margin-bottom: 15px; background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 8px; }
.info-label { display: block; font-size: 11px; color: #ff1f6d; text-transform: uppercase; font-weight: bold; margin-bottom: 4px; }

/* Controle de abas */
.content-section { display: none; }
.content-section.active { display: block; }
</style>
</head>
<body>

<div class="admin-layout">
  <div class="sidebar">
    <h2>ðŸ›  Admin</h2>
    <div class="menu-item active" onclick="showSection('dashboard')">ðŸ“Š Dashboard</div>
    <div class="menu-item" onclick="showSection('alunos')">ðŸ‘¤ Alunos</div>
    <div class="menu-item" onclick="showSection('anamneses')">ðŸ“‹ Anamneses</div>
  </div>

  <div class="main">
    <div class="header">
      <h2 id="section-title">Dashboard</h2>
      <button class="logout" onclick="logout()">Sair</button>
    </div>

    <div id="dashboard" class="content-section active">
        <div class="cards">
          <div class="card"><p>Total de alunos</p><span id="totalUsers">0</span></div>
          <div class="card"><p>Admins</p><span id="totalAdmins">0</span></div>
        </div>
        <div class="admin-container">
          <h2>Postar Novo Treino</h2>
          <form id="training-form">
              <input type="text" id="training-title" placeholder="TÃ­tulo" required>
              <textarea id="training-desc" placeholder="ExercÃ­cios..." rows="5" required></textarea>
              <input type="text" id="training-video" placeholder="Link do vÃ­deo">
              <button type="submit">Publicar Treino</button>
          </form>
        </div>
    </div>

    <div id="alunos" class="content-section">
        <div class="search-box">
          <input type="text" id="search" placeholder="Buscar aluno..." onkeyup="filtrarUsuarios()">
        </div>
        <div class="table-box">
          <table>
            <thead>
              <tr><th>Email</th><th>Plano</th><th>Role</th><th>AÃ§Ãµes</th></tr>
            </thead>
            <tbody id="userList"></tbody>
          </table>
        </div>
    </div>

    <div id="anamneses" class="content-section">
        <div class="table-box">
            <table>
                <thead>
                    <tr><th>Data</th><th>Nome</th><th>Objetivo</th><th>Peso/Alt</th><th>AÃ§Ãµes</th></tr>
                </thead>
                <tbody id="anamneseList">
                    <tr><td colspan="5">Carregando fichas...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
  </div>
</div>

<div id="modalAnamnese" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ðŸ“„ Detalhes da Anamnese</h3>
            <span class="close-modal" onclick="fecharModal()">&times;</span>
        </div>
        <div id="modal-body-content"></div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
import { getFirestore, collection, getDocs, updateDoc, doc, getDoc, setDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAKLvhy6r6tLSMIEt-mZcfHWuiKHHibdcY",
  authDomain: "meusiteteste1-7b880.firebaseapp.com",
  projectId: "meusiteteste1-7b880",
  storageBucket: "meusiteteste1-7b880.appspot.com",
  messagingSenderId: "107598819774",
  appId: "1:107598819774:web:1e369753c4b7908a6209ef"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const ADMIN_EMAIL = "arthurdinizrede@gmail.com";

window.showSection = function(sectionId) {
    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
    document.getElementById(sectionId).classList.add('active');
    if(event) event.currentTarget.classList.add('active');
    document.getElementById('section-title').innerText = sectionId.charAt(0).toUpperCase() + sectionId.slice(1);
    if(sectionId === 'anamneses') carregarAnamneses();
};

onAuthStateChanged(auth, async (user) => {
  if (user) {
    const docRef = doc(db, "users", user.uid);
    const docSnap = await getDoc(docRef);
    if ((docSnap.exists() && docSnap.data().role === "admin") || user.email === ADMIN_EMAIL) {
      document.body.style.display = "block";
      carregarUsuarios();
    } else {
      window.location.href = "aulas.html";
    }
  } else {
    window.location.href = "login.html";
  }
});

async function carregarUsuarios() {
  const snapshot = await getDocs(collection(db, "users"));
  let total = 0; let admins = 0;
  const tbody = document.getElementById("userList");
  tbody.innerHTML = "";
  snapshot.forEach(docSnap => {
    const u = docSnap.data(); total++;
    if (u.role === "admin") admins++;
    tbody.innerHTML += `<tr><td>${u.email}</td><td>${u.plano || "BÃ¡sico"}</td><td>${u.role || "user"}</td>
    <td><button class="action btn-plan" onclick="mudarPlano('${docSnap.id}')">Plano</button></td></tr>`;
  });
  document.getElementById("totalUsers").innerText = total;
  document.getElementById("totalAdmins").innerText = admins;
}

// CARREGAR ANAMNESES COM EXCLUIR
async function carregarAnamneses() {
    const tbody = document.getElementById("anamneseList");
    tbody.innerHTML = "<tr><td colspan='5'>Buscando fichas...</td></tr>";
    try {
        const q = query(collection(db, "anamneses"), orderBy("dataEnvio", "desc"));
        const snapshot = await getDocs(q);
        tbody.innerHTML = "";
        snapshot.forEach(docSnap => {
            const a = docSnap.data();
            const dataFmt = a.dataEnvio?.toDate().toLocaleDateString('pt-BR') || "---";
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${dataFmt}</td>
                <td><b>${a.nome}</b><br><small>${a.email}</small></td>
                <td>${a.objetivo}</td>
                <td>${a.peso}kg / ${a.altura}cm</td>
                <td>
                    <button class="action btn-view" id="view-${docSnap.id}">Detalhes</button>
                    <button class="action btn-delete" id="del-${docSnap.id}">Excluir</button>
                </td>
            `;
            tbody.appendChild(row);
            document.getElementById(`view-${docSnap.id}`).onclick = () => verFicha(a);
            document.getElementById(`del-${docSnap.id}`).onclick = () => excluirAnamnese(docSnap.id, a.nome);
        });
    } catch (e) {
        tbody.innerHTML = "<tr><td colspan='5'>Erro ao carregar.</td></tr>";
    }
}

window.excluirAnamnese = async function(id, nome) {
    if (confirm(`Excluir a ficha de ${nome}?`)) {
        try {
            await deleteDoc(doc(db, "anamneses", id));
            carregarAnamneses();
        } catch (error) { alert("Erro ao excluir."); }
    }
};

window.verFicha = function(dados) {
    const content = document.getElementById("modal-body-content");
    content.innerHTML = `
        <div class="info-item"><span class="info-label">Objetivo</span>${dados.objetivo}</div>
        <div class="info-item"><span class="info-label">LesÃµes</span>${dados.lesao || "Nenhuma"}</div>
        <div class="info-item"><span class="info-label">Medicamentos</span>${dados.medicamento || "Nenhum"}</div>
        <div class="info-item"><span class="info-label">CardÃ­aco</span>${dados.cardiaco}</div>
        <div class="info-item"><span class="info-label">FrequÃªncia</span>${dados.frequencia}x/semana</div>
        <div class="info-item"><span class="info-label">Local</span>${dados.local || "NÃ£o informado"}</div>
    `;
    document.getElementById("modalAnamnese").style.display = "flex";
};

window.fecharModal = () => document.getElementById("modalAnamnese").style.display = "none";
window.logout = () => signOut(auth).then(() => window.location.href = "login.html");
</script>
</body>
</html>